<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Vlife – Hybrid VR (360° / HDR)</title>
<link rel="icon" href="assets/Vlifelogo_1_.png" />
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

<style>
  :root { --gold:#ffd776; --bg:#0b0b0f; --text:#e7e7ea; }
  html,body{margin:0;height:100%;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .topright{position:fixed;right:16px;top:12px;display:flex;align-items:center;gap:10px;z-index:10}
  .brandimg{width:32px;height:32px;border-radius:8px;background:#000;object-fit:contain;box-shadow:0 0 0 1px rgba(255,255,255,.25) inset}
  .brand{color:var(--gold);font-weight:800;letter-spacing:.6px;text-shadow:0 0 12px rgba(255,215,0,.45)}
  .badge{position:fixed;left:16px;top:16px;color:#cfd1d6;font-size:12px;background:rgba(0,0,0,.45);padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);z-index:10}
  .tip{position:fixed;left:16px;bottom:16px;color:#d8dde6;background:rgba(0,0,0,.35);backdrop-filter:blur(8px);
       padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);z-index:10}
</style>
</head>
<body>
  <div class="topright">
    <img class="brandimg" src="assets/Vlifelogo_1_.png" alt="V LIFE" />
    <div class="brand">VLIFE</div>
  </div>
  <div class="badge">Hybrid VR MVP · 360° / HDR</div>
  <div class="tip">Tip: look at the <b>Skins</b> orb to change backgrounds. Gaze at gold orbs to open previews.</div>

  <a-scene renderer="alpha:true antialias:true" background="color:#000" vr-mode-ui="enterVRButton: #enterVR">
    <a-assets id="assets" timeout="30000"></a-assets>

    <!-- RIG + CAMERA + FUSE CURSOR -->
    <a-entity id="rig" position="0 0 0">
      <a-entity id="camera" camera look-controls position="0 1.6 0">
        <a-entity cursor="fuse:true; fuseTimeout:900"
          position="0 0 -1"
          geometry="primitive:ring; radiusInner:0.01; radiusOuter:0.015"
          material="shader:flat; opacity:0.95; color:#ffffff">
        </a-entity>
      </a-entity>
    </a-entity>

    <!-- SKY HOLDER (switches textures) -->
    <a-sky id="spherePhoto" rotation="0 -90 0" color="#0b0d13"></a-sky>

    <!-- GLOBAL LIGHTING (tuned per background) -->
    <a-entity id="ambLight" light="type:ambient; intensity:0.45; color:#aaccff"></a-entity>
    <a-entity id="keyLight" light="type:point; intensity:0.9; distance:18; decay:1; color:#ffffff" position="2 2 -2"></a-entity>

    <!-- ====== FRONT ‘CHOOSE BACKGROUND’ PANEL ====== -->
    <a-entity id="skinsPanel" position="0 1.45 -2">
      <a-entity geometry="primitive:plane; width:1.6; height:0.9"
                material="color:#101317; opacity:0.97; roughness:1; metalness:0"></a-entity>

      <a-entity id="skinsTitle" position="0 0.36 0.01"
                text="value:Choose Background; align:center; width:1.4; wrapCount:26; color:#ffd776; shader:msdf; side:front; font:https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-entity>

      <a-entity id="skinsSubtitle" position="0 0.22 0.01"
                text="value:; align:center; width:1.5; wrapCount:32; color:#8ee58e; shader:msdf; side:front; font:https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-entity>

      <!-- Two rows of small buttons -->
      <a-entity id="skinRow1" position="0 0.04 0.01"></a-entity>
      <a-entity id="skinRow2" position="0 -0.20 0.01"></a-entity>
    </a-entity>

    <!-- ====== LINK ORBS (left/right) ====== -->
    <a-entity id="orbs"></a-entity>

    <!-- ====== 3D PREVIEW PANEL (billboards, spawns in front) ====== -->
    <a-entity id="preview3d" visible="false">
      <a-entity geometry="primitive:plane; width:1.5; height:1"
                material="color:#0f1217; opacity:0.96; roughness:1; metalness:0"></a-entity>

      <a-entity id="p3dTitle" position="0 0.39 0.01"
        text="value:; align:center; width:1.35; wrapCount:28; color:#ffd776; shader:msdf; side:front; font:https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-entity>

      <a-entity id="p3dHost" position="0 0.25 0.01"
        text="value:; align:center; width:1.25; wrapCount:30; color:#9fb4c7; shader:msdf; side:front; font:https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-entity>

      <!-- Buttons -->
      <a-entity id="btnLive" class="clickable" position="-0.45 -0.28 0.02">
        <a-entity geometry="primitive:plane; width:0.56; height:0.16"
                  material="color:#2a2f39; opacity:0.98; roughness:1"></a-entity>
        <a-entity position="0 0 0.01"
          text="value:Live preview; align:center; width:0.48; color:#dce6ff; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-entity>
      </a-entity>

      <a-entity id="btnOpen" class="clickable" position="0.45 -0.28 0.02">
        <a-entity geometry="primitive:plane; width:0.56; height:0.16"
                  material="color:#2a2f39; opacity:0.98; roughness:1"></a-entity>
        <a-entity position="0 0 0.01"
          text="value:Open in new tab; align:center; width:0.48; color:#dce6ff; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-entity>
      </a-entity>

      <a-entity id="btnClose3D" class="clickable" position="0 -0.52 0.02">
        <a-entity geometry="primitive:plane; width:0.44; height:0.14"
                  material="color:#1e232b; opacity:0.98"></a-entity>
        <a-entity position="0 0 0.01"
          text="value:Close; align:center; width:0.36; color:#c9d3e5; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-entity>
      </a-entity>
    </a-entity>

    <!-- ====== SIMPLE OVERLAY (for sites that block iframes) ====== -->
    <a-entity id="overlay" visible="false" position="0 1.45 -1.6">
      <a-entity geometry="primitive:plane; width:1.3; height:0.42"
                material="color:#101317; opacity:0.9"></a-entity>
      <a-entity id="overlayText" position="0 0 0.01"
        text="value:Preview unavailable (site blocks embedding). Use 'Open in new tab'.; align:center; width:1.2; wrapCount:36; color:#e6edf7; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-entity>
    </a-entity>
  </a-scene>

  <!-- Enter VR button target -->
  <button id="enterVR" style="position:fixed;right:16px;bottom:16px;padding:10px 14px;border-radius:12px;border:0;
    background:#fff;color:#000;font-weight:800;box-shadow:0 8px 26px rgba(0,0,0,.35);">VR</button>

<script>
/* ================== HELPERS & COMPONENTS ================== */

const $ = s => document.querySelector(s);
const assets = $('#assets');

AFRAME.registerComponent('billboard-yaw', {
  tick() {
    const camObj = this.el.sceneEl.camera && this.el.sceneEl.camera.el.object3D;
    if (!camObj) return;
    const camWorldPos = new THREE.Vector3();
    camObj.getWorldPosition(camWorldPos);
    // lookAt then zero pitch/roll (yaw only billboard)
    this.el.object3D.lookAt(camWorldPos);
    this.el.object3D.rotation.x = 0;
    this.el.object3D.rotation.z = 0;
  }
});

AFRAME.registerComponent('ui-click', {
  schema: { action: {type: 'string'} },
  init() {
    const fire = () => document.dispatchEvent(new CustomEvent(this.data.action));
    ['click','pointerup','mouseup','touchend'].forEach(ev =>
      this.el.addEventListener(ev, fire, {passive:true})
    );
  }
});

/* ================== STATE ================== */
let BG = [];          // backgrounds (from media.json)
let LINKS = [];       // link definitions (from scenes.json)
let textures = {};    // id -> image preload map
let currentBg = null;
let currentPreview = { title:'', url:'' };

/* ================== LOAD MEDIA & BUILD UI ================== */
async function loadJSON(path){ const r = await fetch(path); return r.json(); }

function hexToRgb(hex){
  const m = hex.replace('#','');
  const n = parseInt(m, 16);
  return { r: (n>>16)&255, g: (n>>8)&255, b: n&255 };
}
function luminanceFromHex(hex){
  const {r,g,b} = hexToRgb(hex);
  // relative luminance (approx)
  return (0.2126*r + 0.7152*g + 0.0722*b)/255;
}

async function init(){
  BG = (await loadJSON('assets/media.json')).backgrounds || [];
  LINKS = (await loadJSON('assets/scenes.json')).links || [];

  // Preload textures
  BG.forEach((b,i)=>{
    const id = 'bg'+i;
    const img = document.createElement('img');
    img.setAttribute('id', id);
    img.setAttribute('src', b.img);
    img.setAttribute('crossorigin','anonymous');
    assets.appendChild(img);
    textures[id] = img;
    b._id = id;
  });

  buildSkinButtons();
  buildLinkOrbs();

  // Set initial BG
  if (BG.length) applyBackground(BG[0]);
}
init();

/* ================== SKINS UI ================== */
function buildSkinButtons(){
  const makeBtn = (bg, x, row) => {
    const root = document.createElement('a-entity');
    root.setAttribute('position', `${x} 0 0`);
    root.setAttribute('class','clickable');
    root.setAttribute('ui-click','action:skin-'+bg._id);

    const pad = document.createElement('a-entity');
    pad.setAttribute('geometry','primitive:plane; width:0.72; height:0.16');
    pad.setAttribute('material','color:#1a1f27; opacity:0.98; roughness:1');
    root.appendChild(pad);

    const label = document.createElement('a-entity');
    label.setAttribute('position','0 0 0.01');
    label.setAttribute('text',`value:${bg.name}; align:center; width:0.64; wrapCount:18; color:#dbe5ff; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json`);
    root.appendChild(label);

    row.appendChild(root);
    document.addEventListener('skin-'+bg._id, ()=>applyBackground(bg));
  };

  const row1 = $('#skinRow1');
  const row2 = $('#skinRow2');
  row1.innerHTML = ''; row2.innerHTML = '';

  const spread = (count, idx) => {
    const totalW = Math.min(count,3) * 0.78;
    const start = - (totalW/2) + 0.39;
    return start + idx*0.78;
  };

  BG.slice(0,3).forEach((bg,i)=> makeBtn(bg, spread(BG.slice(0,3).length,i), row1));
  BG.slice(3,6).forEach((bg,i)=> makeBtn(bg, spread(BG.slice(3,6).length,i), row2));
}

function applyBackground(bg){
  currentBg = bg;

  // Set sky texture
  const sky = $('#spherePhoto');
  if (bg && bg._id && textures[bg._id]) {
    sky.setAttribute('src', '#'+bg._id);
  } else {
    sky.removeAttribute('src');
    sky.setAttribute('color', bg?.fallback || '#0b0d13');
  }

  // Lighting from JSON
  $('#ambLight').setAttribute('light', `type:ambient; intensity:${bg.ambInt || 0.45}; color:${bg.ambient || '#aaccff'}`);
  $('#keyLight').setAttribute('light', `type:point; intensity:${bg.keyInt || 0.9}; distance:18; decay:1; color:#ffffff`);

  // Adaptive orb brightness based on fallback luminance.
  const L = luminanceFromHex(bg.fallback || '#0b0d13'); // 0 (dark) .. 1 (bright)
  // darker bg => brighter orb/halo
  const haloInt = (1 - L) * 2.0 + 0.4;   // 0.4..2.4
  const orbEmiss = (1 - L) * 0.7 + 0.3;  // 0.3..1.0
  document.querySelectorAll('.orb').forEach(o=>{
    o.setAttribute('material', `color:#ffd100; metalness:0.1; roughness:0.3; emissive:#ffcc33; emissiveIntensity:${orbEmiss.toFixed(2)}`);
  });
  document.querySelectorAll('.haloLight').forEach(h=>{
    h.setAttribute('light', `type:point; color:#ffd560; intensity:${haloInt.toFixed(2)}; distance:3.3; decay:1`);
  });

  // Subtitle text
  $('#skinsSubtitle').setAttribute('text',
    `value:Using 360 image: ${bg.name}; align:center; width:1.45; wrapCount:34; color:#9ef59a; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json`);
}

/* ================== LINK ORBS ================== */
function buildLinkOrbs(){
  const root = $('#orbs');
  root.innerHTML = '';

  // Arrange in a horizontal arc
  const radius = 2.2, yawStart = -25, yawStep = 12;
  LINKS.forEach((link, i)=>{
    const yaw = yawStart + i*yawStep;
    const pos = polarOnRing(radius, yaw, 0);
    const group = document.createElement('a-entity');
    group.setAttribute('position', `${pos.x} 1.15 ${pos.z}`);
    group.setAttribute('rotation', `0 ${-yaw} 0`);

    // Halo light for glow
    const halo = document.createElement('a-entity');
    halo.setAttribute('class','haloLight');
    halo.setAttribute('position','0 0 0');
    halo.setAttribute('light','type:point; color:#ffd560; intensity:1.2; distance:3.3; decay:1');
    group.appendChild(halo);

    // Orb
    const orb = document.createElement('a-sphere');
    orb.setAttribute('radius','0.22');
    orb.setAttribute('class','orb clickable');
    orb.setAttribute('material','color:#ffd100; metalness:0.1; roughness:0.3; emissive:#ffcc33; emissiveIntensity:0.6');
    orb.setAttribute('position','0 0 0');
    orb.setAttribute('ui-click','action:open-'+i);
    group.appendChild(orb);

    // Label (faces camera)
    const label = document.createElement('a-entity');
    label.setAttribute('position','0 0.38 0');
    label.setAttribute('billboard-yaw','');
    label.setAttribute('text', `value:${link.title}; align:center; width:1.4; wrapCount:22; color:#ffd776; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json`);
    group.appendChild(label);

    // Click handling
    document.addEventListener('open-'+i, ()=>show3DPreview(link.title, link.url));

    root.appendChild(group);
  });
}
function polarOnRing(r, yawDeg, y){
  const a = THREE.MathUtils.degToRad(yawDeg);
  return {x: r*Math.sin(a), y: y, z: -r*Math.cos(a)};
}

/* ================== 3D PREVIEW (panel spawns in front, billboards) ================== */
function show3DPreview(title, url){
  currentPreview = {title, url};

  $('#p3dTitle').setAttribute('text',
    `value:${title}; align:center; width:1.32; wrapCount:28; color:#ffd776; shader:msdf; side:front; font:https://cdn.aframe.io/fonts/Roboto-msdf.json`);
  $('#p3dHost').setAttribute('text',
    `value:${(new URL(url)).host}; align:center; width:1.22; wrapCount:30; color:#9fb4c7; shader:msdf; side:front; font:https://cdn.aframe.io/fonts/Roboto-msdf.json`);

  const panel = $('#preview3d');
  // position 2m in front of camera
  const camObj = $('#camera').object3D;
  const camPos = new THREE.Vector3(), camDir = new THREE.Vector3();
  camObj.getWorldPosition(camPos);
  camObj.getWorldDirection(camDir);
  const target = camPos.clone().add(camDir.multiplyScalar(2.0));
  panel.object3D.position.copy(target);
  panel.setAttribute('billboard-yaw',''); // face user
  panel.setAttribute('visible', true);
}
function hide3DPreview(){ $('#preview3d').setAttribute('visible', false); }

function showOverlayPreview(){
  const ov = $('#overlay');
  // place just in front of the 3D panel
  const p = $('#preview3d').object3D.position;
  ov.object3D.position.set(p.x, p.y-0.65, p.z);
  ov.setAttribute('billboard-yaw','');
  ov.setAttribute('visible', true);
  // auto hide after a moment
  setTimeout(()=>ov.setAttribute('visible', false), 3500);
}

/* Buttons on the 3D panel */
$('#btnLive').setAttribute('ui-click','action:go-live');
$('#btnOpen').setAttribute('ui-click','action:go-open');
$('#btnClose3D').setAttribute('ui-click','action:go-close');
document.addEventListener('go-live', ()=>{
  // We can't embed many sites; show hint overlay instead.
  showOverlayPreview();
});
document.addEventListener('go-open', ()=>{
  if (currentPreview.url) window.open(currentPreview.url, '_blank', 'noopener');
});
document.addEventListener('go-close', hide3DPreview);
</script>
</body>
</html>