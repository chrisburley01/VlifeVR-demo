<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vlife – Hybrid VR Experience (MVP)</title>
  <link rel="icon" href="assets/Vlifelogo_1_.png" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@5.0.1/dist/aframe-event-set-component.min.js"></script>
  <style>
    :root { --gold:#ffd700; --bg:#0b0b0f; --text:#e7e7ea; }
    body { margin:0; background:#000; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    .hud { position:fixed; inset:auto 16px 16px 16px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; z-index:9; }
    .btn { border:1px solid rgba(255,255,255,.2); background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02)); color:var(--text);
           padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; backdrop-filter:blur(6px);}
    .btn:hover{ border-color:var(--gold); color:var(--gold);}
    .badge { position:fixed; top:12px; left:12px; color:#bdbdc7; font-size:12px; background:rgba(0,0,0,.45);
             padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.1); z-index:9;}
    .note { position:fixed; bottom:12px; left:12px; color:#9ea0aa; font-size:12px; opacity:.85; z-index:9;}
    .gate { position:fixed; inset:0; display:grid; place-items:center;
            background:radial-gradient(1200px 600px at 50% 100%,rgba(255,215,0,.05),rgba(0,0,0,.9)); z-index:10;}
    .gate-inner { max-width:720px; margin:0 16px; background:rgba(12,12,18,.72); padding:22px;
                  border:1px solid rgba(255,255,255,.15); border-radius:16px; text-align:center; color:var(--text);
                  box-shadow:0 16px 72px rgba(0,0,0,.6);}
    .gate-logo { width:min(360px,70vw); height:auto; display:block; margin:0 auto 12px; filter:drop-shadow(0 8px 24px rgba(255,215,0,.18));}
    .gate h1 { margin:6px 0 8px; font-size:22px;}
    .gate p { margin:0 0 16px; color:#c8c8d2;}
    .btn-primary { background:linear-gradient(180deg,#ffe58a,#e7c138); color:#2b2500; border:none;}
    .topright { position:fixed; right:16px; top:12px; display:flex; align-items:center; gap:10px; z-index:9;}
    .brandimg { width:32px; height:32px; object-fit:contain; border-radius:8px; background:#000;
                box-shadow:0 0 0 1px rgba(255,255,255,.25) inset;}
    .brand { color:var(--gold); font-weight:800; letter-spacing:.6px; text-shadow:0 0 12px rgba(255,215,0,.4);}
    .warn { color:#ffb3b3; display:none; margin-top:8px; font-size:12px; }
  </style>
</head>
<body>
  <!-- Top branding -->
  <div class="topright">
    <img class="brandimg" src="assets/Vlifelogo_1_.png" alt="V LIFE" />
    <div class="brand">VLIFE</div>
  </div>
  <div class="badge">Hybrid VR MVP · A-Frame · 360° video</div>

  <!-- Entry overlay -->
  <div class="gate" id="gate">
    <div class="gate-inner">
      <img class="gate-logo" src="assets/Vlifelogo_1_.png" alt="V LIFE logo" />
      <h1>Enter Vlife</h1>
      <p>Immersive 360° experience. Works in browser, mobile, and Meta Quest. For best quality, use a headset.</p>
      <button class="btn btn-primary" id="enterBtn">Enter Experience</button>
      <p id="ytHint" class="warn">This will open a YouTube tour in a new tab (set in <code>assets/scenes.json</code>).</p>
      <p class="warn" id="autoWarn">If video doesn’t start, tap ▶ Play on the HUD (mobile autoplay rules).</p>
      <p style="margin-top:10px;font-size:12px;opacity:.8;">Look around. Gaze at gold orbs to interact. Use HUD to pause or jump.</p>
    </div>
  </div>

  <!-- HUD -->
  <div class="hud">
    <button class="btn" id="playBtn">▶ Play</button>
    <button class="btn" id="pauseBtn">⏸ Pause</button>
    <button class="btn" id="rewindBtn">↺ 0:00</button>
    <button class="btn" id="skip1Btn">⇥</button>
    <button class="btn" id="skip2Btn">⇥</button>
    <button class="btn" id="sceneVideoBtn">Scene: Video</button>
    <button class="btn" id="scenePhotoBtn">Scene: Photo</button>
  </div>
  <div class="note">Put your files in <strong>/assets</strong> and list them in <strong>assets/scenes.json</strong>.</div>

  <!-- VR scene -->
  <a-scene renderer="alpha:true antialias:true" background="color:#000">
    <a-assets timeout="30000">
      <video id="vrVideo" preload="auto" crossOrigin="anonymous" playsinline webkit-playsinline muted loop></video>
      <img id="photoSky" crossorigin="anonymous" />
    </a-assets>

    <!-- Camera rig with reliable gaze cursor + raycaster targetting .clickable -->
    <a-entity id="rig">
      <a-entity id="camera" camera look-controls position="0 1.6 0"
                cursor="fuse:true; fuseTimeout:900"
                raycaster="objects: .clickable">
        <a-entity position="0 0 -1"
          geometry="primitive:ring; radiusInner:0.01; radiusOuter:0.015"
          material="shader:flat; opacity:0.9"></a-entity>
      </a-entity>
    </a-entity>

    <!-- Video sphere scene -->
    <a-entity id="videoScene">
      <a-videosphere id="sphereVideo" src="#vrVideo" rotation="0 -90 0"></a-videosphere>

      <!-- Info panel -->
      <a-entity id="infoPanel" visible="false" geometry="primitive:plane; width:1.9; height:1"
                material="color:#14151a; opacity:0.95" position="0 1.6 -2.2">
        <a-entity position="0 0 0.01"
          text="value: Welcome to Vlife — Hybrid VR.; align:center; width:2.8; color:#ffd700"></a-entity>
        <a-entity position="0 -0.28 0.01"
          text="value: Click hotspots to reveal data, jump timeline, or switch scenes.; align:center; width:2.6; color:#d8d8df"></a-entity>
      </a-entity>

      <!-- Primary hotspots (always present) -->
      <a-entity id="hsInfo" class="clickable"
                geometry="primitive:sphere; radius:0.35"
                material="color:#ffd700; opacity:0.92"
                position="2 1.2 -3"
                event-set__enter="_event:mouseenter; scale:1.2 1.2 1.2"
                event-set__leave="_event:mouseleave; scale:1 1 1"></a-entity>

      <a-entity id="hsJump" class="clickable"
                geometry="primitive:sphere; radius:0.28"
                material="color:#ffd700; opacity:0.92"
                position="-1 1 -2.5"
                event-set__enter="_event:mouseenter; scale:1.2 1.2 1.2"
                event-set__leave="_event:mouseleave; scale:1 1 1"></a-entity>

      <a-entity id="hsLink" class="clickable"
                geometry="primitive:sphere; radius:0.28"
                material="color:#ffd700; opacity:0.92"
                position="0.3 0.8 -1.8"
                event-set__enter="_event:mouseenter; scale:1.2 1.2 1.2"
                event-set__leave="_event:mouseleave; scale:1 1 1"></a-entity>

      <!-- Auto-generated ring of orbs goes here -->
      <a-entity id="orbRing"></a-entity>
    </a-entity>

    <!-- Photo sphere scene -->
    <a-entity id="photoScene" visible="false">
      <a-sky id="spherePhoto" src="#photoSky" rotation="0 -90 0"></a-sky>
      <a-entity position="0 1.6 -2">
        <a-entity geometry="primitive:plane; width:1.8; height:.9" material="color:#14151a; opacity:0.95"></a-entity>
        <a-entity position="0 0 0.01" text="value: Scene B (360° Photo). Click orb to go back.; align:center; width:2.4; color:#ffd700"></a-entity>
      </a-entity>
      <a-entity id="hsBack" class="clickable"
                geometry="primitive:sphere; radius:0.32"
                material="color:#ffd700; opacity:0.92"
                position="0 1 -2.2"
                event-set__enter="_event:mouseenter; scale:1.2 1.2 1.2"
                event-set__leave="_event:mouseleave; scale:1 1 1"></a-entity>
    </a-entity>

    <a-entity light="type:point; intensity:0.6; distance:12" position="1 2 -2"></a-entity>
    <a-entity light="type:ambient; intensity:0.35"></a-entity>
  </a-scene>

  <script>
    const $   = (s)=>document.querySelector(s);
    const $$  = (s)=>document.querySelectorAll(s);

    const videoEl   = $('#vrVideo');
    const photoSky  = $('#photoSky');
    const gate      = $('#gate');
    const infoPanel = $('#infoPanel');

    const skip1Btn  = $('#skip1Btn');
    const skip2Btn  = $('#skip2Btn');
    const ytHint    = $('#ytHint');
    const autoWarn  = $('#autoWarn');

    let manifest = null;

    async function loadManifest() {
      const res = await fetch('assets/scenes.json', {cache:'no-store'});
      if (!res.ok) throw new Error('Missing assets/scenes.json');
      manifest = await res.json();

      // Bind sources
      if (manifest.video && manifest.video.src) {
        videoEl.src = manifest.video.src;
      } else {
        console.warn('No video src set in scenes.json');
      }
      if (manifest.photo && manifest.photo.src) {
        photoSky.setAttribute('src', manifest.photo.src);
      }

      // HUD skip labels
      const [t1, t2] = (manifest.video?.skipTimes || [30, 60]);
      skip1Btn.textContent = `⇥ ${fmtTime(t1)}`;
      skip2Btn.textContent = `⇥ ${fmtTime(t2)}`;

      // Gate button hint for YouTube
      if (manifest.youtube && manifest.youtube.url) {
        ytHint.style.display = 'block';
      }

      // Build full-circle orbs if provided
      buildOrbRing(manifest.orbRing || { count: 0 });
    }

    function fmtTime(s) {
      const m = Math.floor(s/60);
      const sec = String(Math.floor(s%60)).padStart(2,'0');
      return `${m}:${sec}`;
    }

    // Start playback muted for reliability
    async function startPlayback() {
      try {
        videoEl.muted = true;
        await videoEl.play();
        autoWarn.style.display = 'none';
      } catch (e) {
        console.warn('Autoplay blocked', e);
        autoWarn.style.display = 'block';
      }
    }

    // Scene toggles
    function showVideo() {
      AFRAME.scenes[0].querySelector('#videoScene').setAttribute('visible', true);
      AFRAME.scenes[0].querySelector('#photoScene').setAttribute('visible', false);
    }
    function showPhoto() {
      AFRAME.scenes[0].querySelector('#videoScene').setAttribute('visible', false);
      AFRAME.scenes[0].querySelector('#photoScene').setAttribute('visible', true);
    }

    // Orb ring builder (even spacing around user)
    function buildOrbRing({ count=0, radius=3, y=1.2, linkBase="#", jumpEvery=10 }={}) {
      const ring = $('#orbRing');
      ring.innerHTML = '';
      if (!count || count < 1) return;

      for (let i=0;i<count;i++){
        const angle = (i / count) * Math.PI * 2;
        const x = Math.cos(angle) * radius;
        const z = -Math.sin(angle) * radius; // face inward
        const orb = document.createElement('a-entity');
        orb.setAttribute('class','clickable');
        orb.setAttribute('geometry','primitive:sphere; radius:0.22');
        orb.setAttribute('material','color:#ffd700; opacity:0.92');
        orb.setAttribute('position',`${x} ${y} ${z}`);
        orb.setAttribute('look-at','#camera');
        orb.setAttribute('event-set__enter','_event:mouseenter; scale:1.3 1.3 1.3');
        orb.setAttribute('event-set__leave','_event:mouseleave; scale:1 1 1');

        // Example behaviour: alternate jump vs link
        if (i % 2 === 0) {
          orb.dataset.jump = String((i+1) * jumpEvery);
        } else {
          orb.dataset.link = linkBase;
        }

        ring.appendChild(orb);
      }
    }

    // DOM bindings
    document.addEventListener('DOMContentLoaded', async () => {
      await loadManifest();

      $('#enterBtn').addEventListener('click', () => {
        if (manifest?.youtube?.url) {
          // Optional YouTube entry (tour / trailer)
          window.open(manifest.youtube.url, '_blank', 'noopener');
        } else {
          gate.style.display = 'none';
          startPlayback();
        }
      });

      // HUD
      $('#playBtn').addEventListener('click',()=>videoEl.play());
      $('#pauseBtn').addEventListener('click',()=>videoEl.pause());
      $('#rewindBtn').addEventListener('click',()=>{videoEl.currentTime=0;videoEl.play();});

      const [t1, t2] = (manifest.video?.skipTimes || [30, 60]);
      skip1Btn.addEventListener('click',()=>{videoEl.currentTime=t1;videoEl.play();});
      skip2Btn.addEventListener('click',()=>{videoEl.currentTime=t2;videoEl.play();});

      $('#sceneVideoBtn').addEventListener('click',showVideo);
      $('#scenePhotoBtn').addEventListener('click',showPhoto);

      // Primary hotspots
      $('#hsInfo').addEventListener('click',()=>{
        const v = infoPanel.getAttribute('visible');
        infoPanel.setAttribute('visible', !v);
      });

      $('#hsJump').addEventListener('click',()=>{
        const t = (manifest.video?.primaryJumpSec ?? 30);
        videoEl.currentTime = t; videoEl.play();
      });

      $('#hsLink').addEventListener('click',()=>{
        const u = manifest?.linkOut?.url || 'https://chrisburley01.github.io/';
        window.open(u,'_blank','noopener');
      });

      $('#hsBack').addEventListener('click',showVideo);

      // Delegated clicks for auto-made orb ring
      $('#orbRing').addEventListener('click',(e)=>{
        const t = e.target;
        if (!t || !t.dataset) return;
        if (t.dataset.jump) {
          const sec = parseFloat(t.dataset.jump)||0;
          videoEl.currentTime = sec; videoEl.play();
        } else if (t.dataset.link) {
          window.open(t.dataset.link,'_blank','noopener');
        }
      });

      // Keyboard helpers (desktop)
      window.addEventListener('keydown',(ev)=>{
        if (ev.code==='Space'){ ev.preventDefault(); videoEl.paused?videoEl.play():videoEl.pause(); }
        if (ev.code==='ArrowRight'){ videoEl.currentTime += 5; }
        if (ev.code==='ArrowLeft'){ videoEl.currentTime = Math.max(0, videoEl.currentTime - 5); }
      });

      // Try to start playback immediately (muted); user may still need to press ▶ on mobile
      startPlayback();
    });
  </script>
</body>
</html>