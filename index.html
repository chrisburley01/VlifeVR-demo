<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Vlife – Hybrid VR Experience</title>
  <link rel="icon" href="assets/Vlifelogo_1_.png"/>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@5.0.1/dist/aframe-event-set-component.min.js"></script>
  <!-- three.js example loaders (RGBELoader for .hdr/.exr) -->
  <script src="https://unpkg.com/three@0.152.2/examples/js/loaders/RGBELoader.js"></script>
  <style>
    :root{--gold:#ffd700;--text:#e7e7ea}
    body{margin:0;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .gate{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 600px at 50% 100%,rgba(255,215,0,.06),#000 70%);z-index:10}
    .gate-inner{max-width:720px;margin:0 16px;background:rgba(12,12,18,.72);padding:22px;border:1px solid rgba(255,255,255,.15);border-radius:16px;text-align:center;color:var(--text);box-shadow:0 16px 72px rgba(0,0,0,.6)}
    .btn-primary{background:linear-gradient(180deg,#ffe58a,#e7c138);color:#2b2500;border:none;border-radius:12px;padding:10px 18px;font-weight:600;cursor:pointer}
    .topright{position:fixed;right:16px;top:12px;display:flex;align-items:center;gap:10px;z-index:9}
    .brand{color:var(--gold);font-weight:800;letter-spacing:.6px;text-shadow:0 0 12px rgba(255,215,0,.4)}
    .badge{position:fixed;top:12px;left:12px;color:#bdbdc7;font-size:12px;background:rgba(0,0,0,.45);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.1);z-index:9}
  </style>
</head>
<body>
  <div class="topright">
    <img src="assets/Vlifelogo_1_.png" alt="V LIFE" style="width:32px;height:32px;border-radius:8px;box-shadow:0 0 0 1px rgba(255,255,255,.25) inset"/>
    <div class="brand">VLIFE</div>
  </div>
  <div class="badge">Hybrid VR MVP · 360° / HDR</div>

  <div class="gate" id="gate">
    <div class="gate-inner">
      <img src="assets/Vlifelogo_1_.png" alt="V LIFE" style="width:min(360px,70vw);display:block;margin:0 auto 12px"/>
      <h1>Enter Vlife</h1>
      <p>Immersive 360° exploration · JPG/PNG skies or HDR/EXR environments.</p>
      <button class="btn-primary" id="enterBtn" type="button">Enter Experience</button>
      <p style="margin-top:10px;font-size:12px;opacity:.8;">Gaze at gold orbs to open links. Use the Skins orb to switch backgrounds.</p>
    </div>
  </div>

  <a-scene id="scene" renderer="antialias:true physicallyCorrectLights:true" background="color:#000">
    <a-assets timeout="30000"></a-assets>

    <!-- camera + cursor -->
    <a-entity id="rig">
      <a-entity id="camera" camera look-controls wasd-controls-enabled="false" position="0 1.6 0"
                cursor="fuse:true; fuseTimeout:900; rayOrigin:entity"
                raycaster="objects: .clickable; far: 100; interval: 0">
        <a-entity position="0 0 -1" geometry="primitive:ring; radiusInner:0.01; radiusOuter:0.015"
                  material="shader:flat; opacity:0.9"></a-entity>
        <!-- Skins toggle -->
        <a-entity id="skinsToggle" position="-0.75 -0.15 -0.85" class="clickable" visible="false">
          <a-entity geometry="primitive:sphere; radius:0.12"
                    material="color:#ffd700; emissive:#ffd700; emissiveIntensity:0.5; opacity:0.95"></a-entity>
          <a-entity position="0 0.28 0" text="value:Skins; align:center; width:1.8; color:#ffd700; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-entity>
        </a-entity>
      </a-entity>
    </a-entity>

    <!-- dual <a-sky> for image crossfade (hidden when using HDR/EXR) -->
    <a-sky id="skyA" color="#0b0d13" visible="true"  material="opacity:1; transparent:true"></a-sky>
    <a-sky id="skyB" color="#0b0d13" visible="false" material="opacity:0; transparent:true"></a-sky>

    <!-- panel -->
    <a-entity id="skinPanel" position="0 1.55 -2.7" visible="false">
      <a-entity geometry="primitive:plane; width:1.8; height:1.02" material="color:#10131a; opacity:0.95"></a-entity>
      <a-entity position="0 0.44 0.02"
        text="value:Choose Background; align:center; width:3.0; color:#ffd700; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-entity>
      <a-entity id="skinStatus" position="0 0.32 0.02"
        text="value:; align:center; width:2.6; color:#a8f0b0; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-entity>

      <a-entity id="btn0" position="-0.55 0.10 0.02"></a-entity>
      <a-entity id="btn1" position="0 0.10 0.02"></a-entity>
      <a-entity id="btn2" position="0.55 0.10 0.02"></a-entity>
      <a-entity id="btn3" position="-0.55 -0.30 0.02"></a-entity>
      <a-entity id="btn4" position="0 -0.30 0.02"></a-entity>
      <a-entity id="btn5" position="0.55 -0.30 0.02"></a-entity>
    </a-entity>

    <a-entity id="orbRing"></a-entity>

    <a-entity id="keyLight" light="type:point; intensity:0.9; distance:12" position="0 3 0"></a-entity>
    <a-entity id="ambLight" light="type:ambient; intensity:0.45; color:#ffffff"></a-entity>
  </a-scene>

  <script>
    const $ = s => document.querySelector(s);
    const sceneEl = $('#scene');
    const renderer = sceneEl.renderer;
    let LINKS = [
      {title:'360Cities', url:'https://www.360cities.net/'},
      {title:'YouTube VR Channel', url:'https://m.youtube.com/channel/UCzuqhhs6NWbgTzMuM09WKDQ'},
      {title:'YouTube 360 Playlist', url:'https://www.youtube.com/playlist?list=PLU8wpH_LfhmtcxKMb1s46HUz8AVnLiY3O'},
      {title:'Vimeo 360', url:'https://vimeo.com/channels/360videos'},
      {title:'Meta Quest TV', url:'https://www.meta.com/quest/tv/'},
      {title:'AirPano', url:'https://www.airpano.com/'}
    ];

    // tone mapping for HDR
    const onRendererReady = () => {
      const r = sceneEl.renderer;
      if (!r) return;
      r.outputEncoding = THREE.sRGBEncoding;
      r.toneMapping = THREE.ACESFilmicToneMapping;
      r.toneMappingExposure = 1.0;
    };
    sceneEl.addEventListener('render-target-loaded', onRendererReady);

    // Load JSON skins
    async function loadJSON(url){ try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw 0; return await r.json(); }catch{return null;}}
    let SKINS=[];
    let skinIndex=0;
    let usingA=true;

    function openURL(u){ const a=document.createElement('a'); a.href=u; a.target='_blank'; a.rel='noopener'; a.style.display='none'; document.body.appendChild(a); a.click(); a.remove(); }

    function makeOrb(title,url){
      const g=document.createElement('a-entity');
      const orb=document.createElement('a-entity');
      orb.classList.add('clickable','orb');
      orb.setAttribute('geometry','primitive:sphere; radius:0.25');
      orb.setAttribute('material','color:#ffd700; metalness:0.7; roughness:0.25; emissive:#6a5200; emissiveIntensity:0.35; opacity:0.97');
      orb.setAttribute('event-set__enter','_event:mouseenter; scale:1.2 1.2 1.2');
      orb.setAttribute('event-set__leave','_event:mouseleave; scale:1 1 1');
      const label=document.createElement('a-entity');
      label.setAttribute('position','0 0.52 0.02');
      label.setAttribute('text','value:'+title+'; align:center; width:3.4; color:#ffd700; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json');
      const go=()=>openURL(url);
      ['click','pointerup','mouseup','touchend'].forEach(ev=>orb.addEventListener(ev,go,{passive:true}));
      g.appendChild(orb); g.appendChild(label); return g;
    }

    function buildOrbRing(containerId, items, radius=4.6, y=1.25){
      const ring=document.getElementById(containerId); ring.innerHTML='';
      const n=items.length; if(!n) return;
      const panelYaw=$('#skinPanel').object3D.rotation.y;
      const HALF=THREE.MathUtils.degToRad(60); // 120° front gap
      const EDGE=THREE.MathUtils.degToRad(8);
      const TAU=Math.PI*2; const usable=TAU-2*HALF;
      const start=panelYaw+HALF+EDGE; const arc=usable-2*EDGE;
      const step = n>1 ? arc/(n-1) : 0;
      for(let i=0;i<n;i++){
        const t=start+i*step;
        const x=Math.cos(t)*radius, z=-Math.sin(t)*radius;
        const yawDeg=(Math.atan2(-x,-z)*180/Math.PI);
        const g=makeOrb(items[i].title, items[i].url);
        g.setAttribute('position',`${x} ${y} ${z}`);
        g.setAttribute('rotation',`0 ${yawDeg} 0`);
        ring.appendChild(g);
      }
    }

    // IMAGE (JPG/PNG) sky crossfade
    async function setImageSky(src, name){
      const skyA=$('#skyA'), skyB=$('#skyB');
      const front = usingA ? skyB : skyA;
      const back  = usingA ? skyA : skyB;
      sceneEl.object3D.background = null; // ensure HDR is off
      front.removeAttribute('color'); front.setAttribute('src', src); front.setAttribute('rotation','0 -90 0');
      front.setAttribute('visible', true);
      const start=performance.now(), ms=900;
      const step=(t)=>{ const k=Math.min(1,(t-start)/ms); front.setAttribute('material',`opacity:${k}; transparent:true`); back.setAttribute('material',`opacity:${1-k}; transparent:true`); if(k<1) requestAnimationFrame(step); else { back.setAttribute('visible',false); usingA=!usingA; }};
      requestAnimationFrame(step);
      $('#skinStatus').setAttribute('text',`value:Using 360 image: ${name}; align:center; width:2.6; color:#a8f0b0; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json`);
      // sharpen sampling
      setTimeout(()=>{
        const mesh=front.getObject3D('mesh'); const r=sceneEl.renderer;
        if(mesh&&mesh.material&&mesh.material.map&&r){ const tex=mesh.material.map; tex.anisotropy=r.capabilities.getMaxAnisotropy(); tex.needsUpdate=true; }
      },250);
    }

    // HDR/EXR sky/background
    function setHDRSky(src, name){
      const skyA=$('#skyA'), skyB=$('#skyB');
      skyA.setAttribute('visible',false); skyB.setAttribute('visible',false);
      const loader = new THREE.RGBELoader();
      loader.setDataType(THREE.UnsignedByteType);
      loader.load(src, (tex)=>{
        tex.mapping = THREE.EquirectangularReflectionMapping;
        sceneEl.object3D.environment = tex;
        sceneEl.object3D.background  = tex;
        $('#skinStatus').setAttribute('text',`value:Using HDR/EXR: ${name}; align:center; width:2.6; color:#a8f0b0; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json`);
      }, undefined, ()=>{
        $('#skinStatus').setAttribute('text',`value:HDR load failed, falling back to color; align:center; width:2.6; color:#ffcc88; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json`);
        sceneEl.object3D.background = null;
      });
    }

    function buildSkinPanel(){
      const ids=['btn0','btn1','btn2','btn3','btn4','btn5'];
      ids.forEach((id,idx)=>{
        const slot=document.getElementById(id); slot.innerHTML='';
        if(!SKINS[idx]){ slot.setAttribute('visible', false); return; }
        const bg=document.createElement('a-entity');
        bg.setAttribute('geometry','primitive:plane; width:0.62; height:0.24');
        bg.setAttribute('material','color:#161a22; opacity:0.95');
        bg.classList.add('clickable');
        const s=SKINS[idx];
        const choose=()=>{ if(s.hdr){ setHDRSky(s.img, s.name); } else { setImageSky(s.img, s.name); } };
        ['click','pointerdown','touchend'].forEach(ev=>bg.addEventListener(ev,choose,{passive:true}));
        const label=document.createElement('a-entity');
        label.setAttribute('position','0 0 0.02');
        label.setAttribute('text',`value:${s.name}; align:center; width:2.2; color:#dfe3ea; shader:msdf; font:https://cdn.aframe.io/fonts/Roboto-msdf.json`);
        slot.appendChild(bg); slot.appendChild(label);
      });
    }

    async function init(){
      const media = await loadJSON('assets/media.json');
      SKINS = media?.skins || [];
      buildSkinPanel();

      // default = first skin
      if(SKINS[0]){
        if(SKINS[0].hdr){ setHDRSky(SKINS[0].img, SKINS[0].name); }
        else { setImageSky(SKINS[0].img, SKINS[0].name); }
      }

      $('#skinsToggle').setAttribute('visible', true);
      $('#skinPanel').setAttribute('visible', true);

      // links ring
      buildOrbRing('orbRing', LINKS);
    }

    document.getElementById('enterBtn').addEventListener('click', ()=>{ document.getElementById('gate').style.display='none'; init(); });
    document.getElementById('skinsToggle').addEventListener('click', ()=>{ const p=$('#skinPanel'); p.setAttribute('visible', !p.getAttribute('visible')); });
  </script>
</body>
</html>
